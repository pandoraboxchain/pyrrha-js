/**
 * Pyrrha Js
 * Pandora Pyrrha Javascript library
 * 
 * @file index.js
 * @author Kostiantyn Smyrnov <kostysh@gmail.com>
 * @date 2018
 */
'use strict';

require("core-js/modules/es6.array.copy-within");

require("core-js/modules/es6.array.fill");

require("core-js/modules/es6.array.find");

require("core-js/modules/es6.array.find-index");

require("core-js/modules/es6.array.from");

require("core-js/modules/es7.array.includes");

require("core-js/modules/es6.array.iterator");

require("core-js/modules/es6.array.of");

require("core-js/modules/es6.array.sort");

require("core-js/modules/es6.array.species");

require("core-js/modules/es6.date.to-json");

require("core-js/modules/es6.date.to-primitive");

require("core-js/modules/es6.function.has-instance");

require("core-js/modules/es6.function.name");

require("core-js/modules/es6.map");

require("core-js/modules/es6.math.acosh");

require("core-js/modules/es6.math.asinh");

require("core-js/modules/es6.math.atanh");

require("core-js/modules/es6.math.cbrt");

require("core-js/modules/es6.math.clz32");

require("core-js/modules/es6.math.cosh");

require("core-js/modules/es6.math.expm1");

require("core-js/modules/es6.math.fround");

require("core-js/modules/es6.math.hypot");

require("core-js/modules/es6.math.imul");

require("core-js/modules/es6.math.log1p");

require("core-js/modules/es6.math.log10");

require("core-js/modules/es6.math.log2");

require("core-js/modules/es6.math.sign");

require("core-js/modules/es6.math.sinh");

require("core-js/modules/es6.math.tanh");

require("core-js/modules/es6.math.trunc");

require("core-js/modules/es6.number.constructor");

require("core-js/modules/es6.number.epsilon");

require("core-js/modules/es6.number.is-finite");

require("core-js/modules/es6.number.is-integer");

require("core-js/modules/es6.number.is-nan");

require("core-js/modules/es6.number.is-safe-integer");

require("core-js/modules/es6.number.max-safe-integer");

require("core-js/modules/es6.number.min-safe-integer");

require("core-js/modules/es6.number.parse-float");

require("core-js/modules/es6.number.parse-int");

require("core-js/modules/es6.object.assign");

require("core-js/modules/es7.object.define-getter");

require("core-js/modules/es7.object.define-setter");

require("core-js/modules/es7.object.entries");

require("core-js/modules/es6.object.freeze");

require("core-js/modules/es6.object.get-own-property-descriptor");

require("core-js/modules/es7.object.get-own-property-descriptors");

require("core-js/modules/es6.object.get-own-property-names");

require("core-js/modules/es6.object.get-prototype-of");

require("core-js/modules/es7.object.lookup-getter");

require("core-js/modules/es7.object.lookup-setter");

require("core-js/modules/es6.object.prevent-extensions");

require("core-js/modules/es6.object.is");

require("core-js/modules/es6.object.is-frozen");

require("core-js/modules/es6.object.is-sealed");

require("core-js/modules/es6.object.is-extensible");

require("core-js/modules/es6.object.keys");

require("core-js/modules/es6.object.seal");

require("core-js/modules/es6.object.set-prototype-of");

require("core-js/modules/es7.object.values");

require("core-js/modules/es6.promise");

require("core-js/modules/es7.promise.finally");

require("core-js/modules/es6.reflect.apply");

require("core-js/modules/es6.reflect.construct");

require("core-js/modules/es6.reflect.define-property");

require("core-js/modules/es6.reflect.delete-property");

require("core-js/modules/es6.reflect.get");

require("core-js/modules/es6.reflect.get-own-property-descriptor");

require("core-js/modules/es6.reflect.get-prototype-of");

require("core-js/modules/es6.reflect.has");

require("core-js/modules/es6.reflect.is-extensible");

require("core-js/modules/es6.reflect.own-keys");

require("core-js/modules/es6.reflect.prevent-extensions");

require("core-js/modules/es6.reflect.set");

require("core-js/modules/es6.reflect.set-prototype-of");

require("core-js/modules/es6.regexp.constructor");

require("core-js/modules/es6.regexp.flags");

require("core-js/modules/es6.regexp.match");

require("core-js/modules/es6.regexp.replace");

require("core-js/modules/es6.regexp.split");

require("core-js/modules/es6.regexp.search");

require("core-js/modules/es6.regexp.to-string");

require("core-js/modules/es6.set");

require("core-js/modules/es6.symbol");

require("core-js/modules/es7.symbol.async-iterator");

require("core-js/modules/es6.string.anchor");

require("core-js/modules/es6.string.big");

require("core-js/modules/es6.string.blink");

require("core-js/modules/es6.string.bold");

require("core-js/modules/es6.string.code-point-at");

require("core-js/modules/es6.string.ends-with");

require("core-js/modules/es6.string.fixed");

require("core-js/modules/es6.string.fontcolor");

require("core-js/modules/es6.string.fontsize");

require("core-js/modules/es6.string.from-code-point");

require("core-js/modules/es6.string.includes");

require("core-js/modules/es6.string.italics");

require("core-js/modules/es6.string.link");

require("core-js/modules/es7.string.pad-start");

require("core-js/modules/es7.string.pad-end");

require("core-js/modules/es6.string.raw");

require("core-js/modules/es6.string.repeat");

require("core-js/modules/es6.string.small");

require("core-js/modules/es6.string.starts-with");

require("core-js/modules/es6.string.strike");

require("core-js/modules/es6.string.sub");

require("core-js/modules/es6.string.sup");

require("core-js/modules/es6.typed.array-buffer");

require("core-js/modules/es6.typed.int8-array");

require("core-js/modules/es6.typed.uint8-array");

require("core-js/modules/es6.typed.uint8-clamped-array");

require("core-js/modules/es6.typed.int16-array");

require("core-js/modules/es6.typed.uint16-array");

require("core-js/modules/es6.typed.int32-array");

require("core-js/modules/es6.typed.uint32-array");

require("core-js/modules/es6.typed.float32-array");

require("core-js/modules/es6.typed.float64-array");

require("core-js/modules/es6.weak-map");

require("core-js/modules/es6.weak-set");

require("core-js/modules/web.timers");

require("core-js/modules/web.immediate");

require("core-js/modules/web.dom.iterable");

require("regenerator-runtime/runtime");

var _web3 = _interopRequireDefault(require("web3"));

var _ipfsApi = _interopRequireDefault(require("ipfs-api"));

var _package = _interopRequireDefault(require("../package.json"));

var _errors = _interopRequireWildcard(require("./helpers/errors"));

var pandora = _interopRequireWildcard(require("./pandora"));

var kernels = _interopRequireWildcard(require("./kernels"));

var datasets = _interopRequireWildcard(require("./datasets"));

var jobs = _interopRequireWildcard(require("./jobs"));

var workers = _interopRequireWildcard(require("./workers"));

var ipfs = _interopRequireWildcard(require("./ipfs"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

/** Pjs class */
var Pjs =
/*#__PURE__*/
function () {
  _createClass(Pjs, [{
    key: "_web3",
    // web3 setter
    set: function set(value) {
      if (!value || !value.currentProvider) {
        throw (0, _errors.default)(_errors.WEB3_NOT_CONNECTED);
      }

      this.config.web3 = value;
    } // ipfs setter

  }, {
    key: "_ipfs",
    set: function set(value) {
      // @todo Add ipfs connection validation
      this.config.ipfs = value;
    }
    /** Options example
    
    {
        eth: {
            provider: <external_provider>,
            // or
            protocol: 'http',
            host: 'localhost',
            port: ''
        },
        ipfs: {
            protocol: 'http',
            host: 'localhost',
            port: 5001
        },
        contracts: {
            Kernel,  // contract json
            Dataset  // contract json
        },
        addresses: {
            Pandora: '0x58e66b79928cfb362b53c185a6a1fded882bb07d',
            PandoraMarket: '0x6142029abb21ef2e0bffde8d43f15c64f3750fe6'
        }
    }
     
    */

    /**
     * Creates an instance of Pjs.
     * @param {Object} options
     * @memberof Pjs
     */

  }], [{
    key: "Web3",
    // Native Web3 object
    get: function get() {
      return _web3.default;
    } // Native ipfsAPI object

  }, {
    key: "ipfsAPI",
    get: function get() {
      return _ipfsApi.default;
    } // Library version

  }, {
    key: "version",
    get: function get() {
      return _package.default.version;
    }
  }]);

  function Pjs() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    _classCallCheck(this, Pjs);

    // @todo Implement options object validation
    this.version = _package.default.version;
    this.config = {};
    this.isMetaMask = false;

    if (options.eth) {
      if (options.eth.provider) {
        this._web3 = new Pjs.Web3(options.eth.provider);

        if (options.eth.provider.isMetaMask) {
          this.isMetaMask = true;
        }
      } else {
        this._web3 = new Pjs.Web3(new Pjs.Web3.providers.HttpProvider("".concat(options.eth.protocol || 'http', "://").concat(options.eth.host || 'localhost', ":").concat(options.eth.port || '')));
      }

      this.config.contracts = options.contracts || {}; // @todo Validate minimum "required" contracts set 

      this.config.addresses = options.addresses || {}; // @todo Validate addresses "required" option

      this._addMembers('pandora', pandora);

      this._addMembers('kernels', kernels);

      this._addMembers('datasets', datasets);

      this._addMembers('jobs', jobs);

      this._addMembers('workers', workers);
    }

    if (options.ipfs) {
      this._ipfs = Pjs.ipfsAPI(options.ipfs.host, options.ipfs.port, {
        protocol: options.ipfs.protocol
      });

      this._addMembers('ipfs', ipfs);
    }

    this._addApiMembers();
  } // direct apis references


  _createClass(Pjs, [{
    key: "_addApiMembers",
    value: function _addApiMembers() {
      Object.defineProperty(this, 'api', {
        value: {},
        writable: false,
        enumerable: false,
        configurable: false
      });

      if (this.config.web3) {
        var web3 = new Proxy(this.config.web3, {
          get: function get(target, property, receiver) {
            return Reflect.get(target, property, receiver);
          }
        });
        Object.defineProperty(this.api, 'web3', {
          value: web3,
          writable: false,
          enumerable: false,
          configurable: false
        });
      }

      if (this.config.ipfs) {
        var _ipfs = new Proxy(this.config.ipfs, {
          get: function get(target, property, receiver) {
            return Reflect.get(target, property, receiver);
          }
        });

        Object.defineProperty(this.api, 'ipfs', {
          value: _ipfs,
          writable: false,
          enumerable: false,
          configurable: false
        });
      }
    } // Populate library methods

  }, {
    key: "_addMembers",
    value: function _addMembers(subject, members) {
      var self = this;
      Object.defineProperty(self, subject, {
        value: {},
        writable: false,
        enumerable: true,
        configurable: false
      });
      /* istanbul ignore next */

      for (var key in members) {
        var member = void 0;

        if (typeof members[key] === 'function') {
          member = new Proxy(members[key], {
            apply: function apply(target, that, args) {
              // add config object to every methods calls
              args.push(self.config);
              return Reflect.apply(target, self, args);
            }
          });
        } else if (key) {
          member = new Proxy(members[key], {
            get: function get(target, property, receiver) {
              return Reflect.get(target, property, receiver);
            }
          });
        }

        Object.defineProperty(this[subject], key, {
          value: member,
          writable: false,
          enumerable: false,
          configurable: false
        });
      }
    }
  }]);

  return Pjs;
}();

module.exports = Pjs;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJQanMiLCJ2YWx1ZSIsImN1cnJlbnRQcm92aWRlciIsIldFQjNfTk9UX0NPTk5FQ1RFRCIsImNvbmZpZyIsIndlYjMiLCJpcGZzIiwiV2ViMyIsImlwZnNBUEkiLCJwanNQYWNrYWdlIiwidmVyc2lvbiIsIm9wdGlvbnMiLCJpc01ldGFNYXNrIiwiZXRoIiwicHJvdmlkZXIiLCJfd2ViMyIsInByb3ZpZGVycyIsIkh0dHBQcm92aWRlciIsInByb3RvY29sIiwiaG9zdCIsInBvcnQiLCJjb250cmFjdHMiLCJhZGRyZXNzZXMiLCJfYWRkTWVtYmVycyIsInBhbmRvcmEiLCJrZXJuZWxzIiwiZGF0YXNldHMiLCJqb2JzIiwid29ya2VycyIsIl9pcGZzIiwiX2FkZEFwaU1lbWJlcnMiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsIndyaXRhYmxlIiwiZW51bWVyYWJsZSIsImNvbmZpZ3VyYWJsZSIsIlByb3h5IiwiZ2V0IiwidGFyZ2V0IiwicHJvcGVydHkiLCJyZWNlaXZlciIsIlJlZmxlY3QiLCJhcGkiLCJzdWJqZWN0IiwibWVtYmVycyIsInNlbGYiLCJrZXkiLCJtZW1iZXIiLCJhcHBseSIsInRoYXQiLCJhcmdzIiwicHVzaCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQVNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHQTs7QUFDQTs7QUFFQTs7QUFDQTs7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R0FBRyxJQUFJWCxLQUFKLENBQVVRLE9BQU8sQ0FBQ0UsR0FBRCxDQUFqQixFQUF3QjtBQUM3QlQsWUFBQUEsR0FBRyxFQUFFLGFBQVNDLE1BQVQsRUFBaUJDLFFBQWpCLEVBQTJCQyxRQUEzQixFQUFxQztBQUN0QyxxQkFBT0MsT0FBTyxDQUFDSixHQUFSLENBQVlDLE1BQVosRUFBb0JDLFFBQXBCLEVBQThCQyxRQUE5QixDQUFQO0FBQ0g7QUFINEIsV0FBeEIsQ0FBVDtBQUtIOztBQUVEVCxRQUFBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0IsS0FBS1csT0FBTCxDQUF0QixFQUFxQ0csR0FBckMsRUFBMEM7QUFDdEM3QyxVQUFBQSxLQUFLLEVBQUU4QyxNQUQrQjtBQUV0Q2QsVUFBQUEsUUFBUSxFQUFFLEtBRjRCO0FBR3RDQyxVQUFBQSxVQUFVLEVBQUUsS0FIMEI7QUFJdENDLFVBQUFBLFlBQVksRUFBRTtBQUp3QixTQUExQztBQU1IO0FBQ0o7Ozs7OztBQUdMaUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckQsR0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFB5cnJoYSBKc1xuICogUGFuZG9yYSBQeXJyaGEgSmF2YXNjcmlwdCBsaWJyYXJ5XG4gKiBcbiAqIEBmaWxlIGluZGV4LmpzXG4gKiBAYXV0aG9yIEtvc3RpYW50eW4gU215cm5vdiA8a29zdHlzaEBnbWFpbC5jb20+XG4gKiBAZGF0ZSAyMDE4XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgJ0BiYWJlbC9wb2x5ZmlsbCc7XG5pbXBvcnQgV2ViMyBmcm9tICd3ZWIzJztcbmltcG9ydCBpcGZzQVBJIGZyb20gJ2lwZnMtYXBpJztcblxuaW1wb3J0IHBqc1BhY2thZ2UgZnJvbSAnLi4vcGFja2FnZS5qc29uJztcbmltcG9ydCBwanNFcnJvciwge1xuICAgIFdFQjNfTk9UX0NPTk5FQ1RFRFxufSBmcm9tICcuL2hlbHBlcnMvZXJyb3JzJztcblxuaW1wb3J0ICogYXMgcGFuZG9yYSBmcm9tICcuL3BhbmRvcmEnO1xuaW1wb3J0ICogYXMga2VybmVscyBmcm9tICcuL2tlcm5lbHMnO1xuaW1wb3J0ICogYXMgZGF0YXNldHMgZnJvbSAnLi9kYXRhc2V0cyc7XG5pbXBvcnQgKiBhcyBqb2JzIGZyb20gJy4vam9icyc7XG5pbXBvcnQgKiBhcyB3b3JrZXJzIGZyb20gJy4vd29ya2Vycyc7XG5pbXBvcnQgKiBhcyBpcGZzIGZyb20gJy4vaXBmcyc7XG5cbi8qKiBQanMgY2xhc3MgKi9cbmNsYXNzIFBqcyB7XG5cbiAgICAvLyBOYXRpdmUgV2ViMyBvYmplY3RcbiAgICBzdGF0aWMgZ2V0IFdlYjMoKSB7XG4gICAgICAgIHJldHVybiBXZWIzO1xuICAgIH1cblxuICAgIC8vIE5hdGl2ZSBpcGZzQVBJIG9iamVjdFxuICAgIHN0YXRpYyBnZXQgaXBmc0FQSSgpIHtcbiAgICAgICAgcmV0dXJuIGlwZnNBUEk7XG4gICAgfVxuXG4gICAgLy8gTGlicmFyeSB2ZXJzaW9uXG4gICAgc3RhdGljIGdldCB2ZXJzaW9uKCkge1xuICAgICAgICByZXR1cm4gcGpzUGFja2FnZS52ZXJzaW9uO1xuICAgIH1cblxuICAgIC8vIHdlYjMgc2V0dGVyXG4gICAgc2V0IF93ZWIzKHZhbHVlKSB7XG5cbiAgICAgICAgaWYgKCF2YWx1ZSB8fCAhdmFsdWUuY3VycmVudFByb3ZpZGVyKSB7XG4gICAgICAgICAgICB0aHJvdyBwanNFcnJvcihXRUIzX05PVF9DT05ORUNURUQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jb25maWcud2ViMyA9IHZhbHVlO1xuICAgIH1cblxuICAgIC8vIGlwZnMgc2V0dGVyXG4gICAgc2V0IF9pcGZzKHZhbHVlKSB7XG5cbiAgICAgICAgLy8gQHRvZG8gQWRkIGlwZnMgY29ubmVjdGlvbiB2YWxpZGF0aW9uXG4gICAgICAgIHRoaXMuY29uZmlnLmlwZnMgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICAvKiogT3B0aW9ucyBleGFtcGxlXG4gICAgXG4gICAge1xuICAgICAgICBldGg6IHtcbiAgICAgICAgICAgIHByb3ZpZGVyOiA8ZXh0ZXJuYWxfcHJvdmlkZXI+LFxuICAgICAgICAgICAgLy8gb3JcbiAgICAgICAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICAgIHBvcnQ6ICcnXG4gICAgICAgIH0sXG4gICAgICAgIGlwZnM6IHtcbiAgICAgICAgICAgIHByb3RvY29sOiAnaHR0cCcsXG4gICAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICAgIHBvcnQ6IDUwMDFcbiAgICAgICAgfSxcbiAgICAgICAgY29udHJhY3RzOiB7XG4gICAgICAgICAgICBLZXJuZWwsICAvLyBjb250cmFjdCBqc29uXG4gICAgICAgICAgICBEYXRhc2V0ICAvLyBjb250cmFjdCBqc29uXG4gICAgICAgIH0sXG4gICAgICAgIGFkZHJlc3Nlczoge1xuICAgICAgICAgICAgUGFuZG9yYTogJzB4NThlNjZiNzk5MjhjZmIzNjJiNTNjMTg1YTZhMWZkZWQ4ODJiYjA3ZCcsXG4gICAgICAgICAgICBQYW5kb3JhTWFya2V0OiAnMHg2MTQyMDI5YWJiMjFlZjJlMGJmZmRlOGQ0M2YxNWM2NGYzNzUwZmU2J1xuICAgICAgICB9XG4gICAgfVxuICAgICBcbiAgICAqL1xuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYW4gaW5zdGFuY2Ugb2YgUGpzLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAgICogQG1lbWJlcm9mIFBqc1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnMgPSB7fSkge1xuICAgICAgICAvLyBAdG9kbyBJbXBsZW1lbnQgb3B0aW9ucyBvYmplY3QgdmFsaWRhdGlvblxuICAgICAgICB0aGlzLnZlcnNpb24gPSBwanNQYWNrYWdlLnZlcnNpb247XG4gICAgICAgIHRoaXMuY29uZmlnID0ge307XG4gICAgICAgIHRoaXMuaXNNZXRhTWFzayA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChvcHRpb25zLmV0aCkge1xuXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5ldGgucHJvdmlkZXIpIHtcblxuICAgICAgICAgICAgICAgIHRoaXMuX3dlYjMgPSBuZXcgUGpzLldlYjMob3B0aW9ucy5ldGgucHJvdmlkZXIpO1xuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZXRoLnByb3ZpZGVyLmlzTWV0YU1hc2spIHtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNNZXRhTWFzayA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICBcbiAgICAgICAgICAgICAgICB0aGlzLl93ZWIzID0gbmV3IFBqcy5XZWIzKG5ldyBQanMuV2ViMy5wcm92aWRlcnMuSHR0cFByb3ZpZGVyKGAke29wdGlvbnMuZXRoLnByb3RvY29sIHx8ICdodHRwJ306Ly8ke29wdGlvbnMuZXRoLmhvc3QgfHwgJ2xvY2FsaG9zdCd9OiR7b3B0aW9ucy5ldGgucG9ydCB8fCAnJ31gKSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuY29uZmlnLmNvbnRyYWN0cyA9IG9wdGlvbnMuY29udHJhY3RzIHx8IHt9Oy8vIEB0b2RvIFZhbGlkYXRlIG1pbmltdW0gXCJyZXF1aXJlZFwiIGNvbnRyYWN0cyBzZXQgXG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5hZGRyZXNzZXMgPSBvcHRpb25zLmFkZHJlc3NlcyB8fCB7fTsvLyBAdG9kbyBWYWxpZGF0ZSBhZGRyZXNzZXMgXCJyZXF1aXJlZFwiIG9wdGlvblxuXG4gICAgICAgICAgICB0aGlzLl9hZGRNZW1iZXJzKCdwYW5kb3JhJywgcGFuZG9yYSk7XG4gICAgICAgICAgICB0aGlzLl9hZGRNZW1iZXJzKCdrZXJuZWxzJywga2VybmVscyk7XG4gICAgICAgICAgICB0aGlzLl9hZGRNZW1iZXJzKCdkYXRhc2V0cycsIGRhdGFzZXRzKTtcbiAgICAgICAgICAgIHRoaXMuX2FkZE1lbWJlcnMoJ2pvYnMnLCBqb2JzKTtcbiAgICAgICAgICAgIHRoaXMuX2FkZE1lbWJlcnMoJ3dvcmtlcnMnLCB3b3JrZXJzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmlwZnMpIHtcblxuICAgICAgICAgICAgdGhpcy5faXBmcyA9IFBqcy5pcGZzQVBJKFxuICAgICAgICAgICAgICAgIG9wdGlvbnMuaXBmcy5ob3N0LCBcbiAgICAgICAgICAgICAgICBvcHRpb25zLmlwZnMucG9ydCwgXG4gICAgICAgICAgICAgICAgeyBcbiAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6IG9wdGlvbnMuaXBmcy5wcm90b2NvbFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHRoaXMuX2FkZE1lbWJlcnMoJ2lwZnMnLCBpcGZzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX2FkZEFwaU1lbWJlcnMoKTtcbiAgICB9XG5cbiAgICAvLyBkaXJlY3QgYXBpcyByZWZlcmVuY2VzXG4gICAgX2FkZEFwaU1lbWJlcnMoKSB7XG5cbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdhcGknLCB7XG4gICAgICAgICAgICB2YWx1ZToge30sXG4gICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2VcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLndlYjMpIHtcblxuICAgICAgICAgICAgbGV0IHdlYjMgPSBuZXcgUHJveHkodGhpcy5jb25maWcud2ViMywge1xuICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24odGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcGVydHksIHJlY2VpdmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMuYXBpLCAnd2ViMycsIHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogd2ViMyxcbiAgICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jb25maWcuaXBmcykge1xuXG4gICAgICAgICAgICBsZXQgaXBmcyA9IG5ldyBQcm94eSh0aGlzLmNvbmZpZy5pcGZzLCB7XG4gICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wZXJ0eSwgcmVjZWl2ZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5hcGksICdpcGZzJywge1xuICAgICAgICAgICAgICAgIHZhbHVlOiBpcGZzLFxuICAgICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIFBvcHVsYXRlIGxpYnJhcnkgbWV0aG9kc1xuICAgIF9hZGRNZW1iZXJzKHN1YmplY3QsIG1lbWJlcnMpIHtcbiAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzZWxmLCBzdWJqZWN0LCB7XG4gICAgICAgICAgICB2YWx1ZToge30sXG4gICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZVxuICAgICAgICB9KTtcblxuICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqL1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4gbWVtYmVycykge1xuICAgICAgICAgICAgbGV0IG1lbWJlcjtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBtZW1iZXJzW2tleV0gPT09ICdmdW5jdGlvbicpIHtcblxuICAgICAgICAgICAgICAgIG1lbWJlciA9IG5ldyBQcm94eShtZW1iZXJzW2tleV0sIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwbHk6IGZ1bmN0aW9uKHRhcmdldCwgdGhhdCwgYXJncykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRkIGNvbmZpZyBvYmplY3QgdG8gZXZlcnkgbWV0aG9kcyBjYWxsc1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKHNlbGYuY29uZmlnKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuYXBwbHkodGFyZ2V0LCBzZWxmLCBhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkpIHtcblxuICAgICAgICAgICAgICAgIG1lbWJlciA9IG5ldyBQcm94eShtZW1iZXJzW2tleV0sIHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbih0YXJnZXQsIHByb3BlcnR5LCByZWNlaXZlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcGVydHksIHJlY2VpdmVyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpc1tzdWJqZWN0XSwga2V5LCB7XG4gICAgICAgICAgICAgICAgdmFsdWU6IG1lbWJlcixcbiAgICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUGpzO1xuIl19